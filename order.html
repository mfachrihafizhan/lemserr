<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Keranjang Belanja</title>
  <link rel="stylesheet" href="style.css" />
</head>

<!-- Customer Service -->
<div id="cs-popup" class="cs-popup">
  <a href="https://wa.me/6282112291916" target="_blank" class="cs-popup-btn">
    CS
  </a>
</div>

<body>
  <!-- Hamburger -->
  <div id="sidebarToggle" class="sidebar-hamburger">
    <svg width="40" height="40" viewBox="0 0 40 40">
      <rect y="9" width="32" height="5" rx="2.2" fill="#454545"></rect>
      <rect y="19" width="32" height="5" rx="2.2" fill="#454545"></rect>
      <rect y="29" width="32" height="5" rx="2.2" fill="#454545"></rect>
    </svg>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="sidebar">
    <div class="sidebar-pen"></div>
    <nav class="sidebar-menu">
      <a href="index.html" class="sidebar-link">
        <span class="sidebar-icon"></span>
        <span class="sidebar-text">Profil</span>
      </a>
      <a href="tentang.html" class="sidebar-link">
        <span class="sidebar-icon"></span>
        <span class="sidebar-text">Tentang</span>
      </a>
      <a href="produk.html" class="sidebar-link">
        <span class="sidebar-icon"></span>
        <span class="sidebar-text">Produk</span>
      </a>
      <a href="order.html" class="sidebar-link">
        <span class="sidebar-icon"></span>
        <span class="sidebar-text">Order</span>
      </a>
      <a href="ulasan.html" class="sidebar-link">
        <span class="sidebar-icon"></span>
        <span class="sidebar-text">Ulasan</span>
      </a>

      <a href="auth.html" id="btn-login-open" class="sidebar-link">
        <span class="sidebar-icon"></span>
        <span class="sidebar-text">Login</span>
      </a>
      <a href="#" id="btn-logout" class="sidebar-link" style="display: none">
        <span class="sidebar-icon"></span>
        <span class="sidebar-text">Logout</span>
      </a>
      <a href="profil.html" id="btn-profil" class="sidebar-link" style="display: none">
        <span class="sidebar-icon"></span>
        <span class="sidebar-text">Profil</span>
      </a>
    </nav>
  </aside>

  <main class="order-main">
    <div class="order-title">Keranjang Belanja</div>

    <div class="order-table-header">
      <span style="flex:2">Produk</span>
      <span class="harga">Harga Total</span>
      <span class="qty">Kuantitas</span>
      <span style="width:90px">Aksi</span>
    </div>

    <div id="order-list"></div>

    <div class="order-footer">
      <div class="order-footer-left">
        <!-- opsional: pilih semua -->
      </div>
      <div class="order-footer-total">
        Total <span class="total-pesanan">0 Pesanan</span>
        <b>Rp. <span id="totalHarga">0</span></b>
      </div>
      <button class="order-footer-btn" id="orderBtn" disabled>
        Pesan Sekarang
      </button>
    </div>
  </main>

  <!-- SCRIPT SIDEBAR -->
  <script>
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("sidebarToggle");

    toggleBtn.onclick = function (e) {
      sidebar.classList.toggle("active");
      e.stopPropagation();
    };

    document.addEventListener("click", function (e) {
      if (
        window.innerWidth < 600 &&
        !sidebar.contains(e.target) &&
        !toggleBtn.contains(e.target)
      ) {
        sidebar.classList.remove("active");
      }
    });
  </script>

  <!-- LOGIC AUTH + ORDER (LOCALSTORAGE) -->
  <script src="app.js"></script>
  <script>
    function updateOrderFooter() {
      const orders =
        typeof getUserOrders === "function" ? getUserOrders() || [] : [];

      let totalHarga = 0;
      let totalQty = 0;

      orders.forEach((o) => {
        totalHarga += o.totalHarga;
        totalQty += o.qty;
      });

      const totalHargaEl = document.getElementById("totalHarga");
      const totalPesananEl = document.querySelector(".total-pesanan");
      const btnOrder = document.getElementById("orderBtn");

      if (totalHargaEl) totalHargaEl.innerText = totalHarga.toLocaleString();
      if (totalPesananEl)
        totalPesananEl.innerText = totalQty + " Pesanan";
      if (btnOrder) btnOrder.disabled = totalQty === 0;
    }

    document.addEventListener("DOMContentLoaded", function () {
      if (typeof updateAuthUI === "function") {
        updateAuthUI();
      }
      if (typeof renderOrderList === "function") {
        renderOrderList();
      }
      updateOrderFooter();
    });

    // update footer setelah hapus order
    if (typeof deleteOrder === "function") {
      const _deleteOrder = deleteOrder;
      window.deleteOrder = function (id) {
        _deleteOrder(id);
        updateOrderFooter();
      };
    }

    // klik Pesan Sekarang -> kirim ke WhatsApp pakai lsorders + alamat profil
    document.getElementById("orderBtn").addEventListener("click", function () {
      const orders =
        typeof getUserOrders === "function" ? getUserOrders() || [] : [];
      if (!orders.length) return;

      let pesan = "Halo, saya ingin memesan:\n";
      let totalHarga = 0;
      let totalQty = 0;

      orders.forEach((o) => {
        pesan += `- ${o.namaProduk} x ${o.qty} (Rp. ${o.totalHarga.toLocaleString()})\n`;
        totalHarga += o.totalHarga;
        totalQty += o.qty;
      });

      pesan += `\nTotal: ${totalQty} pesanan (Rp. ${totalHarga.toLocaleString()})\n`;

      if (typeof getPrimaryAddress === "function") {
        const addr = getPrimaryAddress();
        if (addr) {
          pesan += "\nPengiriman:\n";
          pesan += `Nama: ${addr.nama}\n`;
          pesan += `HP: ${addr.hp}\n`;
          pesan += `Alamat: ${addr.detail}, ${addr.kota}, ${addr.kodepos}\n`;
        } else {
          pesan += "\nData alamat belum diisi di profil.\n";
        }
      }

      const waNumber = "6282112291916";
      const waURL = `https://wa.me/${waNumber}?text=${encodeURIComponent(
        pesan
      )}`;
      window.open(waURL, "_blank");
    });
  </script>
</body>
</html>
